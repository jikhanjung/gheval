# GHEval 초기 아키텍처 설계

- **날짜**: 2026-02-12
- **유형**: 계획 (Plan)

## Context

지질유산 평가를 위한 PyQt6 데스크탑 앱을 처음부터 구축한다. 지도 위성사진을 통해 지질유산 위치의 훼손 가능성(도로 근접도, 접근성, 식생, 개발 흔적)을 평가하고 DB에 저장하여 리포트 기반 자료로 사용하는 것이 목적이다. DikeFinder 프로젝트의 패턴(flat 파일 구조, Peewee ORM, QSettings, resource_path 등)을 따른다.

**지도**: 1차적으로 OSM(OpenStreetMap) + Leaflet.js 사용 (API 키 불필요, 바로 개발 가능). 향후 카카오지도 JavaScript API 통합 검토.

## 프로젝트 구조

```
gheval/
├── main.py                  # 엔트리포인트
├── GhCommons.py             # 상수, 경로, 유틸리티
├── GhModels.py              # Peewee ORM 모델
├── GhEval.py                # 메인 윈도우 (QMainWindow)
├── GhComponents.py          # 위젯 (지도, 사이트 목록, 평가 패널, 갤러리)
├── GhDialogs.py             # 다이얼로그 (사이트 편집, 설정, 리포트)
├── GhMapBridge.py           # QWebChannel JS↔Python 브릿지
├── templates/
│   └── map_view.html        # OSM+Leaflet 지도 HTML
├── icons/
│   └── gheval.png           # 앱 아이콘
├── migrations/
│   └── 000_base_schema.py   # 초기 스키마 마이그레이션
├── migrate.py               # 마이그레이션 러너
├── requirements.txt
├── README.md
└── CLAUDE.md
```

## DB 스키마 (Peewee ORM)

4개 테이블:

- **geoheritage_site** — 지질유산 위치 (id, site_name, site_desc, latitude, longitude, address, site_type, created_at, updated_at)
- **site_screenshot** — 위성사진 캡처 (id, site FK, file_path, map_type, zoom_level, scale_info, captured_at, note)
- **risk_evaluation** — 훼손 가능성 평가 (id, site FK, screenshot FK, road_proximity 1-5, accessibility 1-5, vegetation_cover 1-5, development_signs 1-5, overall_risk, risk_level, evaluator_notes, evaluated_at)
- **site_photo** — 현장 사진 (id, site FK, file_path, photo_type, description, taken_at, created_at)

위험도 계산: 4개 항목 합산(4-20) → 4-8:LOW, 9-12:MODERATE, 13-16:HIGH, 17-20:CRITICAL

## UI 레이아웃

QSplitter 기반 상하/좌우 분할:
- 상단 좌측: 사이트 목록 (SiteListWidget)
- 상단 우측: OSM/Leaflet 지도 (QWebEngineView)
- 하단: 탭 위젯 (정보 / 평가 / 사진)

## JS↔Python 통신 (QWebChannel)

MapBridge(QObject)를 QWebChannel에 등록:
- Python→JS signals: move_to_location, change_map_type, add/remove/clear markers
- JS→Python slots: on_map_clicked, on_map_ready, on_zoom_changed, on_marker_clicked
- OSM 타일 + Esri World Imagery (위성) 사용, API 키 불필요
- 스크린샷: QWebEngineView.grab() → PNG 저장

## 구현 순서 (7단계)

1. **Phase 1**: 기반 구조 — requirements.txt, GhCommons.py, GhModels.py, main.py, GhEval.py 셸
2. **Phase 2**: 지도 통합 — map_view.html, GhMapBridge.py, MapWidget, SettingsDialog
3. **Phase 3**: 사이트 관리 — SiteListWidget, SiteEditDialog, 스플리터 레이아웃
4. **Phase 4**: 스크린샷 캡처 — grab()→PNG→DB, Ctrl+Shift+S
5. **Phase 5**: 훼손 가능성 평가 — EvaluationPanel (QSlider ×4 + 자동 위험도)
6. **Phase 6**: 사진 및 리포트 — PhotoGalleryWidget, ReportDialog (CSV/JSON)
7. **Phase 7**: 마이그레이션, QSettings, 로깅, CLAUDE.md 업데이트

## 핵심 기술 결정

- PyQt6 + PyQt6-WebEngine
- Peewee ORM (DikeFinder 패턴)
- Flat 파일 구조
- OSM + Leaflet.js (위성: Esri World Imagery)
- QWebChannel 양방향 통신
- QSettings("PaleoBytes", "GHEval")
