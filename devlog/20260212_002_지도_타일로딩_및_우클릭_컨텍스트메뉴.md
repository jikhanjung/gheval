# 지도 타일 로딩 및 우클릭 컨텍스트 메뉴

- **날짜**: 2026-02-12
- **유형**: 작업 기록

## 해결한 문제

### 1. 지도 타일/마커 로딩 실패 (회색 화면)

**원인**: QWebEngineView에서 `file://` 프로토콜로 로컬 HTML을 로드하면 원격 타일 서버(OSM, Esri) 접근이 보안 정책에 의해 차단됨.

**해결**: `GhComponents.py` MapWidget에서 QWebEngineSettings 설정 추가:
```python
settings.setAttribute(QWebEngineSettings.WebAttribute.LocalContentCanAccessRemoteUrls, True)
settings.setAttribute(QWebEngineSettings.WebAttribute.LocalContentCanAccessFileUrls, True)
```

### 2. 마커 아이콘 깨짐

**원인**: Leaflet은 내부적으로 `_getIconUrl` 메서드를 통해 CSS에서 아이콘 경로를 자동 추출하는데, `file://` 환경에서 이 감지가 실패.

**해결**: `templates/map_view.html`에서 자동 감지 메서드를 제거하고 로컬 경로 직접 지정:
```javascript
delete L.Icon.Default.prototype._getIconUrl;
L.Icon.Default.mergeOptions({
    iconUrl: 'lib/marker-icon.png',
    iconRetinaUrl: 'lib/marker-icon-2x.png',
    shadowUrl: 'lib/marker-shadow.png'
});
```

### 3. 지도 타입 전환 UI

**변경**: 툴바에 Map 타입 콤보박스(ROADMAP / SKYVIEW / HYBRID) 추가. View 메뉴의 라디오 액션과 양방향 동기화.

### 4. 우클릭 컨텍스트 메뉴

**변경**: 지도 우클릭 시 다이얼로그가 바로 열리는 대신 컨텍스트 메뉴 표시:
- **Add Site Here** — 해당 좌표로 사이트 추가 다이얼로그
- **Capture Screenshot** — 현재 지도 스크린샷 캡처

구현 경로: JS `contextmenu` 이벤트 → MapBridge `map_right_clicked` 시그널 → MapWidget에서 QMenu 생성 → `add_site_requested` 시그널 → GhEval `_on_add_site_at` 핸들러

## 수정된 파일

| 파일 | 변경 내용 |
|------|-----------|
| `GhComponents.py` | LocalContentCanAccessRemoteUrls 설정, 우클릭 QMenu, add_site_requested 시그널 |
| `GhEval.py` | QActionGroup import 수정(QtGui), 툴바 콤보박스, 우클릭 핸들러 |
| `GhMapBridge.py` | map_right_clicked 시그널, on_map_right_clicked 슬롯 추가 |
| `templates/map_view.html` | Leaflet 아이콘 경로 수정, contextmenu 이벤트 핸들러 추가 |
