# 009: 분석 UX 개선 — Wait Cursor, 거리 표시, 마커 개선

**날짜**: 2026-02-13

## 변경 요약

1. 도로 거리 측정 시 국도/지방도만 대상 (Overpass API 전환)
2. 분석 중 Wait Cursor 표시
3. 분석 완료 후 사이트 재선택으로 road line + analysis circle 자동 복원
4. 도로 라인에 실제 거리 숫자 표시
5. 마커에 사이트 이름 상시 표시, 마우스 hover 시 위도/경도 표시

## 변경 내용

### GhCommons.py — Overpass API 전환

- OSRM Nearest API → Overpass API로 전면 교체
- 포함 도로: `trunk`, `primary`, `secondary`, `tertiary` (+`_link`) — 국도/지방도/시군도
- 제외 도로: `motorway` (고속도로), `residential`/`service` (골목길)
- 5km 반경 검색, 도로 선분 위 최근접점 투영으로 정확한 거리 계산
- `_haversine()` 삭제 → `_closest_point_on_segment()` 추가

### GhEval.py — Wait Cursor + 분석 후 재선택

- `_run_full_analysis()`: `QApplication.setOverrideCursor(WaitCursor)` 추가
- `_analysis_finish()`: `restoreOverrideCursor()`, `eval_panel.set_site(site)` 호출로 저장된 데이터 기반 road line + analysis circle 자동 표시
- `_analysis_error()`: `restoreOverrideCursor()` 추가

### GhMapBridge.py — 거리 파라미터 추가

- `draw_road_line()`: `distance_m` optional 파라미터 추가, JSON에 포함

### GhComponents.py — Signal 확장

- `road_line_requested` signal: `float × 4` → `float × 5` (distance_m 추가)
- `set_site()`/`_on_measure_finished()`에서 `ev.road_distance` 전달
- `MapWidget.show_road_line()`: `distance_m` 파라미터 추가

### templates/map_view.html — 거리 라벨 + 마커 개선

**도로 거리 라벨:**
- `.road-distance-label` CSS 클래스 (빨간 반투명 배경)
- `showRoadLine()`: 라인 중간 지점에 거리 표시 (`123 m` / `1.23 km`)
- `clearRoadLine()`: 라벨도 함께 제거

**마커 개선:**
- `bindTooltip(name, {permanent: true})`: 사이트 이름 항상 표시
- `bindPopup(lat, lng)` + `mouseover`/`mouseout`: hover 시 좌표 표시

## 수정 파일

| 파일 | 변경 |
|------|------|
| `GhCommons.py` | Overpass API 전환, `_closest_point_on_segment` 추가, `_haversine` 삭제 |
| `GhEval.py` | WaitCursor, 분석 후 사이트 재선택, distance_m 전달 |
| `GhMapBridge.py` | `draw_road_line` distance_m 파라미터 |
| `GhComponents.py` | signal 5인자 확장, distance_m 전달 |
| `templates/map_view.html` | 거리 라벨, 마커 이름 상시 표시, hover 좌표 |
