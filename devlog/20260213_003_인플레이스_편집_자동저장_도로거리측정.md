# 인플레이스 편집, 자동 저장, 도로 거리 측정 기록

- **날짜**: 2026-02-13
- **유형**: 작업 기록

## 변경 개요

Site Info 패널을 읽기 전용에서 직접 편집 가능한 방식으로, Evaluation 패널을 수동 저장에서 자동 저장으로 전환. 도로 거리 측정값을 DB에 기록하고 지도에 직선 경로를 표시하는 기능 추가.

---

## 1. SiteInfoPanel 인플레이스 편집

**이전**: QLabel(읽기 전용) + "Edit Site..." 버튼 → SiteEditDialog 팝업
**이후**: 직접 편집 가능한 위젯 + 변경 즉시 DB 자동 저장

### 위젯 교체

| 필드 | 이전 | 이후 |
|------|------|------|
| Name | QLabel | QLineEdit |
| Coordinates | QLabel | QDoubleSpinBox x2 (lat/lng, 소수점 6자리) |
| Address | QLabel | QLineEdit |
| Type | QLabel | QComboBox (editable, 7개 항목) |
| Description | QTextEdit (readOnly) | QTextEdit (편집 가능) |
| Edit 버튼 | QPushButton | **삭제** |

### 자동 저장 메커니즘

- QLineEdit/QDoubleSpinBox: `editingFinished` → `_save_field()`
- QComboBox: `currentTextChanged` → `_save_field()`
- QTextEdit: `textChanged` → `_save_field()`
- `_loading` 플래그로 `set_site()` 중 프로그래밍적 값 변경 시 저장 방지

### 시그널 변경

- `edit_requested` 시그널 **삭제**
- `site_updated` 시그널 **추가** — 저장 후 emit, 메인 윈도우에서 사이트 리스트/마커 리프레시

---

## 2. EvaluationPanel 자동 저장

**이전**: 슬라이더 조작 후 "Save Evaluation" 버튼 클릭
**이후**: 슬라이더/노트 변경 즉시 DB 자동 저장

- "Save Evaluation" 버튼 **삭제**
- 슬라이더 `valueChanged`, notes `textChanged` → `_auto_save()` 호출
- `_loading` 플래그 패턴 동일 적용
- `_save_evaluation()` → `_auto_save()`로 리네임

---

## 3. GhEval.py 메인 윈도우 수정

- `_edit_current_site()` 메서드 **삭제**
- `action_save_site` 액션 **삭제** (메뉴, 툴바, 액션 생성 모두 제거)
- `info_panel.edit_requested` 연결 → `info_panel.site_updated` 연결로 교체
- `_on_site_info_updated()` 추가: `blockSignals`로 리스트 재로드 시 `set_site` 재호출 방지

```python
def _on_site_info_updated(self):
    site_id = self.current_site.id
    self.site_list.list_widget.blockSignals(True)
    self.site_list.load_sites()
    self.site_list.select_site_by_id(site_id)
    self.site_list.list_widget.blockSignals(False)
    self._refresh_markers()
```

- SiteEditDialog은 새 사이트 생성(`_new_site`, `_on_add_site_at`) 용도로 유지

---

## 4. 도로 거리 측정값 DB 기록

**문제**: Measure 버튼으로 측정한 도로 거리가 DB에 저장되지 않아 사이트 재선택 시 사라짐

### 모델 변경 (`GhModels.py`)

`RiskEvaluation`에 필드 추가:
```python
road_distance = DoubleField(null=True)      # 001 마이그레이션
road_snap_lat = DoubleField(null=True)      # 002 마이그레이션
road_snap_lng = DoubleField(null=True)      # 002 마이그레이션
```

### 마이그레이션

- `migrations/001_add_road_distance.py`: `road_distance` 컬럼 추가
- `migrations/002_add_road_snap_coords.py`: `road_snap_lat`, `road_snap_lng` 컬럼 추가

### 버그 수정

`_on_measure_finished`에서 슬라이더 값이 이전과 동일하면 `valueChanged`가 발생하지 않아 `_auto_save`가 호출되지 않는 문제 → 측정 완료 후 `_auto_save()`를 명시적으로 호출하여 해결.

---

## 5. 도로까지 직선 경로 지도 표시

OSRM Nearest API에서 받은 snap 좌표(가장 가까운 도로 지점)를 활용하여 사이트~도로 간 직선을 지도에 표시.

### `GhCommons.py`

`fetch_road_distance` 반환값 변경: `float` → `(distance_m, snap_lat, snap_lng)` 튜플

### `GhComponents.py`

- `RoadDistanceWorker.finished` 시그널: `pyqtSignal(float)` → `pyqtSignal(float, float, float)`
- `EvaluationPanel`에 시그널 추가:
  - `road_line_requested(float, float, float, float)` — site_lat, site_lng, road_lat, road_lng
  - `road_line_cleared()`
- `_last_road_snap = (lat, lng)` 튜플로 snap 좌표 추적
- `set_site()`: 저장된 snap 좌표가 있으면 `road_line_requested` emit, 없으면 `road_line_cleared` emit
- `MapWidget`에 `show_road_line()`, `clear_road_line()` 메서드 추가

### `GhMapBridge.py`

시그널 추가: `show_road_line(str)`, `clear_road_line()`
메서드 추가: `draw_road_line()`, `remove_road_line()`

### `templates/map_view.html`

```javascript
// 빨간 점선 + 도로 지점에 빨간 원형 마커
roadLine = L.polyline(
    [[data.site_lat, data.site_lng], [data.road_lat, data.road_lng]],
    {color: 'red', weight: 2, dashArray: '6, 4'}
).addTo(map);
roadEndMarker = L.circleMarker([data.road_lat, data.road_lng], {
    radius: 5, color: 'red', fillColor: 'red', fillOpacity: 0.8
}).addTo(map);
```

### `GhEval.py`

시그널 연결:
```python
self.eval_panel.road_line_requested.connect(self.map_widget.show_road_line)
self.eval_panel.road_line_cleared.connect(self.map_widget.clear_road_line)
```

---

## 수정된 파일

| 파일 | 변경 내용 |
|------|-----------|
| `GhCommons.py` | `fetch_road_distance` 반환값에 snap 좌표 추가 |
| `GhModels.py` | `RiskEvaluation`에 `road_distance`, `road_snap_lat`, `road_snap_lng` 필드 추가 |
| `GhComponents.py` | SiteInfoPanel 인플레이스 편집, EvaluationPanel 자동 저장, 도로 거리/snap 좌표 저장 및 직선 표시 |
| `GhEval.py` | `_edit_current_site`/`action_save_site` 제거, `site_updated`/road line 시그널 연결 |
| `GhMapBridge.py` | `show_road_line`/`clear_road_line` 시그널 및 메서드 추가 |
| `templates/map_view.html` | `showRoadLine`/`clearRoadLine` JS 함수 및 시그널 연결 |
| `migrations/001_add_road_distance.py` | `road_distance` 컬럼 마이그레이션 |
| `migrations/002_add_road_snap_coords.py` | `road_snap_lat`/`road_snap_lng` 컬럼 마이그레이션 |
