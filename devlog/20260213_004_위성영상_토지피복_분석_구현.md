# 위성영상 토지피복(Land Cover) 분석 구현

- **날짜**: 2026-02-13
- **유형**: 작업 기록 (Work Record)
- **계획**: `20260213_P02_위성영상_토지피복_분석.md`

## 변경 사항

사이트 주변 위성영상을 HSV+ExG로 자동 분석하여 5개 토지 피복 클래스(Dense Vegetation, Sparse Vegetation, Bare Rock/Soil, Built-up/Paved, Water)의 비율을 산출하는 기능을 구현.

### 수정 파일

| 파일 | 변경 내용 |
|------|-----------|
| `GhModels.py` | RiskEvaluation에 landcover 7개 필드 추가 |
| `migrations/003_add_landcover_fields.py` | **신규** — landcover 컬럼 마이그레이션 |
| `GhLandCover.py` | **신규** — QPixmap→numpy 변환, HSV+ExG 분류 로직, meters_to_pixels |
| `requirements.txt` | numpy>=1.21.0, opencv-python-headless>=4.5.0 추가 |
| `GhComponents.py` | LandCoverWorker(QThread), EvaluationPanel에 분석 UI 추가 |
| `GhEval.py` | landcover 시그널 연결, 줌 조정+캡처→워커 흐름 |

### 주요 결정

- **opencv-python-headless** 사용 — Qt와의 GUI 충돌 방지
- **QImage.bits()** → numpy 직접 변환 — Pillow 의존성 불필요
- **2초 딜레이** 후 캡처 — 위성 타일 로딩 대기
- **분석 시 줌 17 + SKYVIEW** 자동 전환 — 최적 분석 해상도
- **미분류 픽셀** 비례 배분 — 합계 100% 보장
- **슬라이더 자동 조정**: vegetation_cover와 development_signs 슬라이더를 분석 결과에 따라 자동 설정

### 시그널 흐름

```
Analyze 버튼 클릭
  → EvaluationPanel.landcover_analysis_requested(radius_m)
  → GhEvalMainWindow._on_landcover_requested()
    → SKYVIEW + zoom 17 전환
    → 2초 딜레이 후 web_view.grab()
    → EvaluationPanel.start_landcover_worker(pixmap, ...)
  → LandCoverWorker.finished(results)
    → _display_landcover_results(): 바 차트 UI 갱신
    → _apply_landcover_to_sliders(): 슬라이더 자동 조정
    → _save_landcover_results(): DB 저장
```
