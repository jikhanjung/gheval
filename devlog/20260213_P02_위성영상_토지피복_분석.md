# 위성영상 토지피복(Land Cover) 분석 기능

- **날짜**: 2026-02-13
- **유형**: 계획 (Plan)

## Context

지질유산 사이트의 훼손 위험도를 평가할 때, 현재는 사용자가 위성사진을 눈으로 보고 vegetation_cover, development_signs 슬라이더를 수동 조정한다. 사이트 주변 위성영상을 자동 분석하여 토지 피복 비율(식생/암석/건물 등)을 산출하면 평가의 객관성과 효율성을 높일 수 있다.

**분석 범위**: 사이트 중심 반경 500m (기본값, 설정 가능)
**분석 방법**: HSV 색공간 분류 + ExG(Excess Green Index) 식생 보정 (RGB 전용, 딥러닝 불필요)

## 토지 피복 분류 체계

Anderson Level I을 지질유산 평가에 맞게 단순화한 5개 클래스:

| 클래스 | 설명 | HSV 기준 (대략) |
|--------|------|-----------------|
| Dense Vegetation | 수목 울창, 짙은 녹색 | H:35-85, S>40, V>30 + ExG 높음 |
| Sparse Vegetation | 초지, 관목, 연한 녹색 | H:35-85, S:20-40 또는 ExG 중간 |
| Bare Rock/Soil | 암석 노출, 나지, 갈색 | H:10-30, S:20-60 |
| Built-up/Paved | 건물, 도로, 포장면 | S<20 (회색 계열) + 높은 V 편차 |
| Water | 수체 | H:90-130, S>30, V<60 |

## 구현 계획

### Phase 1: 모델 확장 + 마이그레이션

**`GhModels.py`** — RiskEvaluation에 필드 추가:
```python
landcover_dense_veg = IntegerField(null=True)      # % (0-100)
landcover_sparse_veg = IntegerField(null=True)
landcover_bare = IntegerField(null=True)
landcover_built = IntegerField(null=True)
landcover_water = IntegerField(null=True)
landcover_radius_m = IntegerField(default=500, null=True)
landcover_analyzed_at = DateTimeField(null=True)
```

**`migrations/003_add_landcover_fields.py`** 생성

### Phase 2: 분석 로직 (`GhLandCover.py` 신규)

새 파일에 분석 핵심 로직 분리:

```python
def qpixmap_to_numpy(qpixmap) -> np.ndarray
    # QPixmap → numpy BGR array 변환

def extract_circle_region(image, center_px, radius_px) -> np.ndarray
    # 원형 마스크 적용하여 분석 영역만 추출

def classify_landcover(image_bgr) -> dict
    # HSV 변환 → 클래스별 마스크 생성 → ExG 보정 → 비율 계산
    # 반환: {"dense_veg": 35, "sparse_veg": 20, "bare": 25, "built": 18, "water": 2}

def meters_to_pixels(lat, zoom, meters) -> int
    # 위도 + 줌 레벨 기반 미터→픽셀 변환
```

### Phase 3: QThread 워커 (`GhComponents.py`)

RoadDistanceWorker 패턴을 따르는 LandCoverWorker:

```python
class LandCoverWorker(QThread):
    finished = pyqtSignal(dict)   # 분류 결과 dict
    error = pyqtSignal(str)

    def __init__(self, pixmap, lat, lng, zoom, radius_m=500):
        ...

    def run(self):
        # 1. QPixmap → numpy
        # 2. meters_to_pixels로 반경 계산
        # 3. 이미지 중심에서 원형 영역 추출
        # 4. classify_landcover 실행
        # 5. 결과 emit
```

### Phase 4: EvaluationPanel UI 확장 (`GhComponents.py`)

기존 vegetation_cover 슬라이더 그룹에 "Analyze" 버튼 추가:

- **Analyze 버튼**: 클릭 시 현재 지도 뷰 캡처 → 분석 실행
- **결과 표시**: 각 클래스별 % 바 또는 레이블
- **슬라이더 자동 조정**: 분석 결과에 따라 vegetation_cover, development_signs 슬라이더 값 자동 제안
- **분석 반경 설정**: 콤보박스 (250m / 500m / 1km)

### Phase 5: MapWidget 연동 (`GhComponents.py`, `GhEval.py`)

- EvaluationPanel에서 분석 요청 시그널 → GhEval → MapWidget.grab()으로 pixmap 전달
- 분석 시 적정 줌 레벨(17)로 자동 조정 후 캡처
- 분석 결과를 DB에 자동 저장 (auto_save 패턴 활용)

## 시그널 흐름

```
[Analyze 버튼 클릭]
  → EvaluationPanel.landcover_analysis_requested 시그널
  → GhEvalMainWindow._on_landcover_requested()
    → MapWidget: 줌 17로 조정, 짧은 딜레이 후 grab()
    → LandCoverWorker(pixmap, lat, lng, zoom, radius) 시작
  → LandCoverWorker.finished
    → EvaluationPanel._on_landcover_finished(results)
      → UI 결과 표시
      → vegetation_cover / development_signs 슬라이더 자동 조정
      → _auto_save() → DB 저장
```

## 의존성 추가 (`requirements.txt`)

```
numpy>=1.21.0
opencv-python-headless>=4.5.0
```

pillow는 불필요 — QImage.bits()로 직접 numpy 변환 가능.
opencv-python-headless 사용 (GUI 없는 버전, Qt와 충돌 방지).

## 수정 대상 파일

| 파일 | 변경 |
|------|------|
| `GhModels.py` | RiskEvaluation에 landcover 필드 7개 추가 |
| `GhLandCover.py` | **신규** — 분석 로직 (qpixmap 변환, HSV+ExG 분류) |
| `GhComponents.py` | LandCoverWorker, EvaluationPanel에 분석 UI 추가 |
| `GhEval.py` | landcover 시그널 연결, 줌 조정+캡처 흐름 |
| `requirements.txt` | numpy, opencv-python-headless 추가 |
| `migrations/003_add_landcover_fields.py` | **신규** — landcover 컬럼 마이그레이션 |

## 검증 방법

1. `python migrate.py`로 마이그레이션 실행 확인
2. 앱 실행 → 사이트 선택 → Evaluation 탭 → "Analyze" 버튼 클릭
3. 분석 결과(5개 클래스 %)가 UI에 표시되는지 확인
4. 슬라이더가 자동 조정되는지 확인
5. 사이트 재선택 시 저장된 분석 결과가 복원되는지 확인
6. 반경 변경(250m/500m/1km) 후 재분석 시 결과 변화 확인
