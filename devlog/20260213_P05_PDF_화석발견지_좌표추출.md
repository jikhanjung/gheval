# PDF 논문에서 화석 발견지 좌표 추출

- **날짜**: 2026-02-13
- **유형**: 계획 (Plan)

## Context

지질/고생물학 논문 PDF를 입력받아 논문에 언급된 화석 발견지의 위치 정보(좌표, 지명)를 자동 추출하는 기능이 필요하다. 단일 PDF, 복수 PDF, 또는 디렉토리 단위 일괄 처리를 지원한다. 추출된 좌표는 GeoHeritageSite로 등록하여 기존 평가 워크플로우에 연결한다.

## 핵심 요구사항

1. PDF 텍스트 추출 (일반 PDF + 스캔 PDF OCR)
2. 텍스트에서 좌표(위경도) 패턴 탐색 및 파싱
3. 지명 추출 → 지오코딩으로 좌표 변환 (좌표 없는 경우)
4. 단일/복수/디렉토리 일괄 처리 + 진행률 표시
5. 추출 결과 사용자 검토 → 선택적 DB 등록

## 기술 요소 분석

### 1. PDF 텍스트 추출

| 라이브러리 | 라이선스 | 장점 | 단점 |
|-----------|---------|------|------|
| **PyMuPDF (fitz)** | AGPL-3.0 | 가장 빠름(~42ms/page), 다단 레이아웃 지원, 이미지 추출 내장, 페이지→이미지 렌더링 가능 | AGPL 라이선스(배포 시 상용 라이선스 필요) |
| pdfplumber | MIT | 테이블 추출 최강, Pythonic API | 다단 레이아웃 미지원, 느림 |
| pdfminer.six | MIT | 문자 단위 위치 데이터, LAParams 세밀 조정 | 가장 느림, 이미지 추출 불가 |
| pypdf | BSD-3 | 가벼움, 허용적 라이선스 | 복잡한 레이아웃에서 텍스트 품질 떨어짐 |

**선택: PyMuPDF** — 학술논문의 다단(2-column) 레이아웃 처리가 핵심이고, OCR 파이프라인을 위한 페이지→이미지 렌더링도 필요하다. `pymupdf4llm` 모듈은 구조화된 Markdown 출력을 제공한다. AGPL 라이선스는 개인/내부 도구로 사용 시 문제없고, 오픈소스 배포 시에도 호환된다.

**난이점:**
- 학술논문의 다단 레이아웃에서 텍스트 순서가 뒤섞일 수 있음 → PyMuPDF의 `column_boxes()` 유틸리티 또는 pymupdf4llm 활용
- 각주, 참고문헌 영역에서 불필요한 좌표가 잡힐 수 있음 → 페이지 영역 필터링 필요

### 2. 스캔 PDF OCR

**스캔 페이지 탐지 방법:**
```
1. page.get_text()로 텍스트 추출 → 50자 미만이면 스캔 의심
2. page.get_images()로 이미지 면적 계산 → 페이지 면적의 95%+ 차지하면 전면 스캔
```

| OCR 엔진 | 라이선스 | 한국어 | 네이티브 의존 | 설치 크기 |
|----------|---------|--------|-------------|----------|
| **pytesseract** | Apache 2.0 | `kor+eng` | Tesseract 바이너리 | ~30MB |
| EasyOCR | Apache 2.0 | `ko+en` | 없음 (PyTorch) | ~2GB |
| PaddleOCR | Apache 2.0 | 지원 | PaddlePaddle | ~1GB |

**선택: pytesseract (1차) → EasyOCR (정확도 부족 시 업그레이드)**

pytesseract가 가장 가볍고 한국어+영어 혼용 처리가 가능하다. 학술논문은 인쇄 품질이 양호하므로 Tesseract 정확도로 충분할 가능성이 높다.

**난이점:**
- Tesseract 네이티브 바이너리 설치 필요 (Windows: UB Mannheim 인스톨러, Linux: `apt install tesseract-ocr tesseract-ocr-kor`)
- PyInstaller 번들링 시 Tesseract 바이너리와 tessdata 파일을 data로 포함해야 함 (~30MB 추가)
- 스캔 품질이 낮으면 OCR 정확도 급감 → 이미지 전처리(이진화, 기울기 보정) 필요할 수 있음
- 한국어 OCR에서 도(°), 분('), 초(") 기호가 다른 문자로 인식되는 경우 있음

### 3. 좌표 추출

기존 `GhCommons.py`의 `parse_coordinates()`는 깨끗한 단일 좌표 입력을 파싱한다. PDF에서는 **연속된 텍스트 안에 포함된 좌표를 스캔**해야 하므로 별도의 패턴 매칭이 필요하다.

**처리해야 할 좌표 형식:**

```
# 소수점 도 (Decimal Degrees)
37.5665, 126.9780
37.5665°N, 126.9780°E

# 도분초 (DMS) — 학술논문에서 가장 흔함
37°33'59.4"N 126°58'40.8"E
37° 33′ 59.4″ N, 126° 58′ 40.8″ E

# 한글 도분초 — 한국 논문에서 사용
북위 37도 33분 59.4초, 동경 126도 58분 40.8초
N 37도 33분 59초

# UTM (국제 논문에서 간혹 사용)
52S 0294519 6229136
```

**구현 방식:**
- 연속 텍스트에서 좌표 패턴을 찾는 정규식 스캐너 작성
- 기존 `parse_coordinates()`를 활용하여 발견된 후보를 파싱
- 한글 도분초 패턴(도/분/초, 북위/동경) 추가 필요

**난이점:**
- False positive: 본문 중 좌표처럼 보이는 숫자 조합 (예: "Figure 37, p. 126")
- 같은 좌표가 본문, 표, 캡션 등에 여러 번 등장 → 중복 제거 필요
- UTM 좌표는 존 번호+원점 정보 없이 변환 불가 → pyproj 필요
- OCR된 텍스트에서 °, ', " 기호가 다른 문자로 인식될 수 있음 → 퍼지 매칭 필요

### 4. 지명 추출 및 지오코딩

좌표가 명시되지 않고 지명만 언급된 경우 (예: "경남 고성군 하이면 덕명리") 대비.

**NER (Named Entity Recognition):**
- spaCy 한국어 모델 (`ko_core_news_lg`) — LOC/GPE 엔티티 인식
- 설치: `pip install spacy && python -m spacy download ko_core_news_lg` (~500MB)

**지오코딩:**
- Nominatim (OSM) — 무료, API 키 불필요, 1 req/sec 제한
- VWORLD API (vworld.kr) — 한국 주소에 특화, API 키 필요
- 기존 프로젝트가 OSM 기반이므로 Nominatim이 자연스러운 선택

**난이점:**
- 한국어 NER 품질이 일반 지명에는 괜찮지만 "하이면 덕명리" 같은 세부 행정구역은 누락할 수 있음
- Nominatim으로 한국 지역 마을 단위 지명을 찾기 어려울 수 있음
- Rate limit (1 req/sec)으로 대량 지오코딩 시 느림
- spaCy 모델이 500MB로 앱 크기 증가 → 선택적 의존성으로 처리 필요

### 5. 지도 이미지 추출 (부가 기능)

논문의 Figure 중 지도를 추출하여 Leaflet 위에 오버레이하는 기능.

**이미지 추출:** PyMuPDF의 `page.get_images()` + `doc.extract_image(xref)` + `page.get_image_rects(xref)`로 위치 정보 포함 추출.

**지도 vs 비지도 판별 (휴리스틱):**
1. 이미지 캡션 텍스트에 "map", "location", "locality", "지도", "위치도", "조사지역" 키워드 탐지
2. 최소 크기 필터 (200x200 이상)
3. 이미지 주변 텍스트 분석

**지도 이미지 지오레퍼런싱:**
- 자동화: 지도 가장자리의 좌표 눈금을 OCR로 읽어 아핀 변환 → **매우 어렵고 불안정**
- 반자동: 사용자가 지도 위 4점의 좌표를 지정 → 실용적
- Leaflet의 `L.imageOverlay(url, bounds, {opacity: 0.7})`로 오버레이

**난이점:**
- 자동 지오레퍼런싱은 연구 수준의 문제 → 1차 구현에서 제외
- 지도 이미지 판별은 완벽하지 않음 → 사용자 확인 필수
- 고해상도 지도 이미지는 메모리를 많이 사용함

### 6. 일괄 처리 및 UI

**QThread 기반 백그라운드 처리:**
```
PdfProcessorWorker(QThread)
  signals:
    - progress(current, total, filename) → 진행률 바
    - file_completed(filename, results) → 증분 결과 표시
    - error_occurred(filename, error_msg) → 비치명적 에러
    - all_completed(all_results) → 최종 요약
  cancellation:
    - _cancelled 플래그로 루프 중단
```

**에러 처리 원칙: 하나의 불량 PDF가 전체 배치를 중단시키지 않는다.**
- 손상/암호화된 PDF → 건너뛰기 + 로그
- 텍스트 없는 스캔 PDF → OCR 파이프라인으로 라우팅 또는 건너뛰기
- OCR 실패 → 건너뛰기 + 경고
- 좌표 미발견 → "사이트 미탐지"로 보고 (에러 아님)
- 지오코딩 API 실패 → 네트워크 타임아웃 재시도 + 캐싱

**결과 클래스:**
```
BatchResult:
  successful: [(filename, [extracted_sites])]
  failed: [(filename, error_message)]
  skipped: [(filename, reason)]
  warnings: [(filename, warning)]
```

## 의존성 요약

### 최소 구현 (MVP)

| 컴포넌트 | 라이브러리 | 라이선스 | 추가 크기 |
|---------|-----------|---------|----------|
| PDF 텍스트 추출 | PyMuPDF | AGPL-3.0 | ~30MB |
| OCR | pytesseract + Pillow | Apache 2.0 | ~30MB(네이티브) |
| 좌표 추출 | regex (내장) | — | 0 |
| 지오코딩 | Nominatim (HTTP) | ODbL | 0 |

**MVP 추가 의존성 합계: ~60MB + Tesseract 네이티브 설치**

### 전체 구현

| 컴포넌트 | 라이브러리 | 추가 크기 |
|---------|-----------|----------|
| 위 MVP 전체 | — | ~60MB |
| NER (지명 추출) | spaCy + ko_core_news_lg | ~500MB |
| UTM 좌표 변환 | pyproj | ~20MB |
| OCR 고정밀 (선택) | EasyOCR + PyTorch | ~2GB |

## 구현 단계

### Phase 1: MVP — 좌표 직접 추출 (핵심)

1. **`GhPdfExtractor.py` 신규 생성** — PDF 처리 모듈
   - `PdfTextExtractor`: PyMuPDF 기반 텍스트 추출 (다단 레이아웃 처리)
   - `CoordinateScanner`: 연속 텍스트에서 좌표 패턴 스캔 (정규식)
   - `PdfProcessorWorker(QThread)`: 배치 처리 워커

2. **`GhCommons.py` 확장**
   - `scan_coordinates_in_text(text)` 함수 추가 — 텍스트에서 모든 좌표 후보 탐색
   - 한글 도분초 패턴 지원 추가 (북위/동경/도/분/초)

3. **`GhDialogs.py`에 `PdfImportDialog` 추가**
   - 파일/디렉토리 선택 UI
   - 진행률 표시
   - 추출 결과 테이블 (체크박스로 선택적 임포트)
   - 지도 프리뷰 (선택된 좌표를 지도에 표시)

4. **메뉴 통합** — GhEval.py에 "Import from PDF..." 메뉴 항목

### Phase 2: OCR 지원

5. **스캔 페이지 탐지 + OCR 파이프라인**
   - 페이지별 텍스트/이미지 비율로 스캔 여부 판단
   - pytesseract로 OCR (한국어+영어)
   - OCR 품질 경고 표시

6. **설정에 OCR 옵션 추가**
   - Tesseract 경로 설정
   - OCR 활성화/비활성화
   - 언어 선택

### Phase 3: 지명 기반 추출 (선택)

7. **spaCy NER 기반 지명 추출**
   - 한국어 NER로 LOC/GPE 엔티티 추출
   - Nominatim 지오코딩
   - 결과에 신뢰도 표시 (좌표 직접 추출 vs 지오코딩)

### Phase 4: 지도 이미지 (미래, 선택)

8. **PDF 내 지도 이미지 추출 및 표시**
   - 이미지 추출 + 캡션 기반 지도 판별
   - 사용자 지정 좌표 바운더리로 Leaflet 오버레이

## 영향 받는 파일

| 파일 | 변경 |
|------|------|
| `GhPdfExtractor.py` | **신규** — PDF 처리 모듈 |
| `GhCommons.py` | 좌표 스캔 함수 추가, 한글 도분초 파싱 |
| `GhDialogs.py` | PdfImportDialog 추가 |
| `GhEval.py` | 메뉴 항목 추가 |
| `GhModels.py` | GeoHeritageSite에 source_pdf 필드 추가 (선택) |
| `requirements.txt` | PyMuPDF, pytesseract, Pillow 추가 |

## 리스크 및 대응

| 리스크 | 영향 | 대응 |
|--------|------|------|
| PyMuPDF AGPL 라이선스 | 상용 배포 제한 | 오픈소스로 배포하거나, pdfplumber로 대체 가능 |
| Tesseract 네이티브 설치 요구 | 사용자 설치 부담 | Phase 2에서 다루고, 설치 가이드 제공. OCR은 선택적 기능으로 |
| 좌표 False positive | 잘못된 사이트 등록 | 사용자 검토 단계 필수. 신뢰도 점수 표시 |
| 한국어 OCR 기호 오인식 | 좌표 파싱 실패 | 퍼지 매칭, 문자 대체 규칙 적용 |
| spaCy 모델 크기 (500MB) | 앱 크기 증가 | 선택적 의존성. 없으면 지명 추출 비활성화 |
| 자동 지오레퍼런싱 불안정 | 잘못된 지도 오버레이 | Phase 4에서 반자동(사용자 지정)으로만 구현 |
