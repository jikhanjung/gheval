# 008: 도로 거리 측정 — 도로 유형 필터링

**날짜**: 2026-02-13

## 변경 요약

도로 거리 측정 시 국도/지방도만 대상으로 하도록 변경. 고속도로, 골목길 등 제외.

## 변경 이유

기존 OSRM Nearest API는 driving 네트워크의 모든 도로를 대상으로 가장 가까운 지점을 반환하므로, 고속도로나 골목길도 포함됨. 지질유산 접근성 평가에는 국도/지방도급 도로만 의미가 있음.

## 변경 내용

### GhCommons.py — `fetch_road_distance()` 전면 교체

| 항목 | 변경 전 (OSRM) | 변경 후 (Overpass) |
|------|----------------|-------------------|
| API | OSRM Nearest `/nearest/v1/driving/` | Overpass API `overpass-api.de` |
| 도로 필터 | 없음 (driving 전체) | highway 태그 필터링 |
| 응답 | snap 좌표 1개 | way 지오메트리 전체 |
| 거리 계산 | haversine(사이트↔snap) | 선분 위 최근접점 투영 |
| timeout | 10초 | 20초 (+10초 여유) |

**포함 도로 (OSM highway 태그):**

| OSM 태그 | 한국 도로 분류 |
|----------|--------------|
| `trunk` / `trunk_link` | 국도급 자동차전용도로 |
| `primary` / `primary_link` | 국도 |
| `secondary` / `secondary_link` | 지방도 |
| `tertiary` / `tertiary_link` | 시군도 |

**제외 도로:**

| OSM 태그 | 한국 도로 분류 |
|----------|--------------|
| `motorway` / `motorway_link` | 고속도로 |
| `residential` | 주거지역 도로 |
| `service` | 서비스 도로 |
| `living_street` | 생활 도로 |
| `unclassified` | 미분류 소로 |

### 새 함수: `_closest_point_on_segment()`

도로 선분(A→B) 위에서 사이트(P)까지 가장 가까운 점을 계산.
- 위도/경도를 로컬 미터 좌표로 변환 (`111320 * cos(lat)`)
- 선분 위 투영 파라미터 `t`를 `[0, 1]`로 클램프
- 미터 좌표에서 거리 계산 후 위도/경도로 역변환

### 삭제 함수: `_haversine()`

OSRM snap 좌표까지의 거리 계산에만 사용되었으므로 제거.

## 인터페이스 변경 없음

`fetch_road_distance(lat, lng)` → `(distance_m, snap_lat, snap_lng)` 반환값 동일.
`RoadDistanceWorker`, `_run_full_analysis` 등 호출측 수정 불필요.

## 수정 파일

| 파일 | 변경 |
|------|------|
| `GhCommons.py` | `fetch_road_distance` Overpass 전환, `_closest_point_on_segment` 추가, `_haversine` 삭제 |
