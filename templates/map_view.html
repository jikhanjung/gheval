<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHEval Map</title>
    <link rel="stylesheet" href="lib/leaflet.css" />
    <script src="lib/leaflet.js"></script>
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <style>
        * { margin: 0; padding: 0; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        .site-marker-icon {
            background: none;
            border: none;
        }
        .imagery-info {
            background: rgba(0,0,0,0.65);
            color: #fff;
            padding: 3px 8px;
            font-size: 11px;
            border-radius: 3px;
            font-family: monospace;
        }
        .road-distance-label {
            background: none;
            color: #c00;
            padding: 0;
            font-size: 11px;
            font-weight: bold;
            font-family: monospace;
            white-space: nowrap;
            text-shadow: 1px 1px 2px #fff, -1px -1px 2px #fff,
                         1px -1px 2px #fff, -1px 1px 2px #fff;
        }
    </style>
</head>
<body>
<div id="map"></div>
<script>
    var map, bridge, currentMarker, siteMarkers = {};
    var osmLayer, satelliteLayer, hybridLayer;
    var currentMapType = "ROADMAP";
    var roadLine = null, roadEndMarker = null, roadDistLabel = null, analysisCircle = null;
    var waybackLayer = null;
    var _waybackMeta = null;
    var _dateDebounce = null;
    var _selectedMarkerId = null;

    // Fix default marker icon paths for local files
    delete L.Icon.Default.prototype._getIconUrl;
    L.Icon.Default.mergeOptions({
        iconUrl: 'lib/marker-icon.png',
        iconRetinaUrl: 'lib/marker-icon-2x.png',
        shadowUrl: 'lib/marker-shadow.png'
    });

    function makePinIcon(color) {
        return L.divIcon({
            className: '',
            html: '<svg width="25" height="41" viewBox="0 0 25 41" xmlns="http://www.w3.org/2000/svg">'
                + '<path d="M12.5 0C5.6 0 0 5.6 0 12.5c0 2.2.6 4.3 1.6 6.1L12.5 41l10.9-22.4c1-1.8 1.6-3.9 1.6-6.1C25 5.6 19.4 0 12.5 0z" fill="' + color + '" stroke="#fff" stroke-width="1.5"/>'
                + '<circle cx="12.5" cy="12.5" r="5" fill="#fff"/></svg>',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });
    }
    var defaultPinIcon = makePinIcon('#3388ff');
    var selectedPinIcon = makePinIcon('#e74c3c');

    // Tile layers
    osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
    });

    satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: '&copy; Esri',
        maxZoom: 19
    });

    var labelLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19,
        opacity: 0.4
    });

    // Initialize map
    map = L.map('map', {
        center: [37.5665, 126.9780],
        zoom: 10,
        layers: [osmLayer]
    });

    L.control.scale({ metric: true, imperial: false }).addTo(map);

    // Imagery info overlay
    var imageryInfo = L.control({position: 'bottomleft'});
    imageryInfo.onAdd = function() {
        var div = L.DomUtil.create('div', 'imagery-info');
        div.style.display = 'none';
        return div;
    };
    imageryInfo.addTo(map);

    map.on('moveend', function() {
        if (currentMapType === 'ROADMAP') {
            imageryInfo.getContainer().style.display = 'none';
            return;
        }
        if (_dateDebounce) clearTimeout(_dateDebounce);
        _dateDebounce = setTimeout(function() {
            var c = map.getCenter();
            if (currentMapType === 'SKYVIEW_SUMMER' && _waybackMeta && _waybackMeta.metadataUrl) {
                fetchWaybackDate(c.lat, c.lng);
            } else {
                fetchCurrentDate(c.lat, c.lng);
            }
        }, 500);
    });

    function fetchCurrentDate(lat, lng) {
        var geom = encodeURIComponent(JSON.stringify({x:lng, y:lat, spatialReference:{wkid:4326}}));
        var url = 'https://services.arcgisonline.com/arcgis/rest/services/World_Imagery/MapServer/4/query'
            + '?f=json&returnGeometry=false&spatialRel=esriSpatialRelIntersects'
            + '&geometryType=esriGeometryPoint&geometry=' + geom
            + '&outFields=SRC_DATE2,NICE_DESC,SRC_RES,MinMapLevel,MaxMapLevel';
        fetch(url).then(function(r) { return r.json(); }).then(function(data) {
            showImageryDate(data.features, false);
        }).catch(function() {});
    }

    function fetchWaybackDate(lat, lng) {
        var geom = encodeURIComponent(JSON.stringify({x:lng, y:lat, spatialReference:{wkid:4326}}));
        var layerId = map.getZoom() >= 18 ? 4 : 5;
        var url = _waybackMeta.metadataUrl + '/' + layerId + '/query'
            + '?f=json&returnGeometry=false&spatialRel=esriSpatialRelIntersects'
            + '&geometryType=esriGeometryPoint&geometry=' + geom
            + '&outFields=SRC_DATE2,NICE_DESC,SRC_RES';
        fetch(url).then(function(r) { return r.json(); }).then(function(data) {
            showImageryDate(data.features, true);
        }).catch(function() {
            showWaybackFallback();
        });
    }

    function showImageryDate(features, isWayback) {
        var container = imageryInfo.getContainer();
        var zoom = map.getZoom();
        var f = features && features.length > 0 ? features[0] : null;
        if (!isWayback && features) {
            for (var i = 0; i < features.length; i++) {
                var a = features[i].attributes;
                if (zoom >= a.MinMapLevel && zoom <= a.MaxMapLevel) { f = features[i]; break; }
            }
        }
        if (f && f.attributes.SRC_DATE2) {
            var d = new Date(f.attributes.SRC_DATE2);
            var ds = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
            var desc = f.attributes.NICE_DESC || '';
            var parts = [];
            if (isWayback && _waybackMeta) parts.push('Wayback ' + _waybackMeta.date);
            parts.push('Captured: ' + ds);
            if (desc) parts.push(desc);
            container.innerHTML = parts.join(' | ');
            container.style.display = '';
        } else {
            if (isWayback && _waybackMeta) { showWaybackFallback(); }
            else { container.style.display = 'none'; }
        }
    }

    function showWaybackFallback() {
        var container = imageryInfo.getContainer();
        if (_waybackMeta) {
            container.innerHTML = 'Wayback ' + _waybackMeta.date;
            container.style.display = '';
        } else {
            container.style.display = 'none';
        }
    }

    // Current click marker
    currentMarker = null;

    map.on('click', function(e) {
        if (bridge) {
            var data = JSON.stringify({
                lat: e.latlng.lat,
                lng: e.latlng.lng
            });
            bridge.on_map_clicked(data);
        }
    });

    map.on('contextmenu', function(e) {
        if (bridge) {
            var data = JSON.stringify({
                lat: e.latlng.lat,
                lng: e.latlng.lng
            });
            bridge.on_map_right_clicked(data);
        }
    });

    map.on('zoomend', function() {
        if (bridge) {
            bridge.on_zoom_changed(map.getZoom());
        }
    });

    function changeMapType(mapType) {
        currentMapType = mapType;
        map.eachLayer(function(layer) {
            if (layer === osmLayer || layer === satelliteLayer || layer === labelLayer || layer === waybackLayer) {
                map.removeLayer(layer);
            }
        });
        if (mapType === "ROADMAP") {
            map.addLayer(osmLayer);
            imageryInfo.getContainer().style.display = 'none';
        } else if (mapType === "SKYVIEW") {
            map.addLayer(satelliteLayer);
        } else if (mapType === "SKYVIEW_SUMMER") {
            if (waybackLayer) {
                map.addLayer(waybackLayer);
            } else {
                map.addLayer(satelliteLayer); // fallback until version loaded
            }
        } else if (mapType === "HYBRID") {
            map.addLayer(satelliteLayer);
            map.addLayer(labelLayer);
        }
        // Trigger imagery date refresh for satellite modes
        if (mapType !== "ROADMAP") {
            if (_dateDebounce) clearTimeout(_dateDebounce);
            _dateDebounce = setTimeout(function() {
                var c = map.getCenter();
                if (mapType === 'SKYVIEW_SUMMER' && _waybackMeta && _waybackMeta.metadataUrl) {
                    fetchWaybackDate(c.lat, c.lng);
                } else {
                    fetchCurrentDate(c.lat, c.lng);
                }
            }, 500);
        }
    }

    function moveToLocation(jsonStr) {
        var data = JSON.parse(jsonStr);
        var lat = data.lat || 37.5665;
        var lng = data.lng || 126.9780;
        var zoom = data.zoom || map.getZoom();
        map.setView([lat, lng], zoom);
    }

    function addSiteMarker(jsonStr) {
        var data = JSON.parse(jsonStr);
        var id = data.id;
        var lat = data.lat;
        var lng = data.lng;
        var name = data.name || "";

        if (siteMarkers[id]) {
            map.removeLayer(siteMarkers[id]);
        }

        var icon = (_selectedMarkerId === id) ? selectedPinIcon : defaultPinIcon;
        var marker = L.marker([lat, lng], {icon: icon}).addTo(map);
        // Permanent name label
        if (name) {
            marker.bindTooltip(name, {permanent: true, direction: 'top', offset: [0, -42]});
        }
        // Lat/lng tooltip on hover via popup
        marker.bindPopup(lat.toFixed(6) + ', ' + lng.toFixed(6), {
            closeButton: false, offset: [0, -30]
        });
        marker.on('mouseover', function() { marker.openPopup(); });
        marker.on('mouseout', function() { marker.closePopup(); });
        marker.on('click', function() {
            if (bridge) {
                bridge.on_marker_clicked(JSON.stringify({id: id}));
            }
        });
        siteMarkers[id] = marker;
    }

    function highlightSiteMarker(idStr) {
        var id = parseInt(idStr);
        if (_selectedMarkerId !== null && siteMarkers[_selectedMarkerId]) {
            siteMarkers[_selectedMarkerId].setIcon(defaultPinIcon);
        }
        if (siteMarkers[id]) {
            siteMarkers[id].setIcon(selectedPinIcon);
            _selectedMarkerId = id;
        } else {
            _selectedMarkerId = null;
        }
    }

    function removeSiteMarker(idStr) {
        var id = parseInt(idStr);
        if (siteMarkers[id]) {
            map.removeLayer(siteMarkers[id]);
            delete siteMarkers[id];
        }
    }

    function clearSiteMarkers() {
        for (var id in siteMarkers) {
            map.removeLayer(siteMarkers[id]);
        }
        siteMarkers = {};
    }

    function setClickMarker(jsonStr) {
        var data = JSON.parse(jsonStr);
        if (currentMarker) {
            map.removeLayer(currentMarker);
        }
        currentMarker = L.marker([data.lat, data.lng]).addTo(map);
    }

    function clearClickMarker() {
        if (currentMarker) {
            map.removeLayer(currentMarker);
            currentMarker = null;
        }
    }

    function showRoadLine(jsonStr) {
        var data = JSON.parse(jsonStr);
        clearRoadLine();
        roadLine = L.polyline(
            [[data.site_lat, data.site_lng], [data.road_lat, data.road_lng]],
            {color: 'red', weight: 2, dashArray: '6, 4'}
        ).addTo(map);
        roadEndMarker = L.circleMarker([data.road_lat, data.road_lng], {
            radius: 5, color: 'red', fillColor: 'red', fillOpacity: 0.8
        }).addTo(map);
        // Distance label at midpoint
        if (data.distance_m != null) {
            var midLat = (data.site_lat + data.road_lat) / 2;
            var midLng = (data.site_lng + data.road_lng) / 2;
            var dist = data.distance_m;
            var label = dist >= 1000 ? (dist / 1000).toFixed(2) + ' km' : Math.round(dist) + ' m';
            roadDistLabel = L.marker([midLat, midLng], {
                icon: L.divIcon({
                    className: '',
                    html: '<div class="road-distance-label">' + label + '</div>',
                    iconSize: [0, 0],
                    iconAnchor: [0, 10]
                }),
                interactive: false
            }).addTo(map);
        }
    }

    function clearRoadLine() {
        if (roadLine) { map.removeLayer(roadLine); roadLine = null; }
        if (roadEndMarker) { map.removeLayer(roadEndMarker); roadEndMarker = null; }
        if (roadDistLabel) { map.removeLayer(roadDistLabel); roadDistLabel = null; }
    }

    function showAnalysisCircle(jsonStr) {
        var data = JSON.parse(jsonStr);
        clearAnalysisCircle();
        analysisCircle = L.circle([data.lat, data.lng], {
            radius: data.radius,
            color: '#00bfff',
            weight: 2,
            fillColor: '#00bfff',
            fillOpacity: 0.1,
            dashArray: '6, 4'
        }).addTo(map);
    }

    function clearAnalysisCircle() {
        if (analysisCircle) { map.removeLayer(analysisCircle); analysisCircle = null; }
    }

    function setWaybackVersion(jsonStr) {
        var data = JSON.parse(jsonStr);
        _waybackMeta = data;
        if (waybackLayer) { map.removeLayer(waybackLayer); }
        var url = 'https://wayback.maptiles.arcgis.com/arcgis/rest/services/World_Imagery/WMTS/1.0.0/default028mm/MapServer/tile/'
                  + data.release + '/{z}/{y}/{x}';
        waybackLayer = L.tileLayer(url, {
            attribution: '&copy; Esri (Wayback)',
            maxZoom: 19
        });
        if (currentMapType === "SKYVIEW_SUMMER") {
            // Remove fallback satellite layer if present
            if (map.hasLayer(satelliteLayer)) { map.removeLayer(satelliteLayer); }
            map.addLayer(waybackLayer);
        }
    }

    // Initialize QWebChannel bridge
    new QWebChannel(qt.webChannelTransport, function(channel) {
        bridge = channel.objects.bridge;

        bridge.move_to_location.connect(function(jsonStr) {
            moveToLocation(jsonStr);
        });

        bridge.change_map_type.connect(function(mapType) {
            changeMapType(mapType);
        });

        bridge.add_site_marker.connect(function(jsonStr) {
            addSiteMarker(jsonStr);
        });

        bridge.remove_site_marker.connect(function(idStr) {
            removeSiteMarker(idStr);
        });

        bridge.clear_site_markers.connect(function() {
            clearSiteMarkers();
        });

        bridge.highlight_site_marker.connect(function(idStr) {
            highlightSiteMarker(idStr);
        });

        bridge.set_click_marker.connect(function(jsonStr) {
            setClickMarker(jsonStr);
        });

        bridge.clear_click_marker.connect(function() {
            clearClickMarker();
        });

        bridge.show_road_line.connect(function(jsonStr) {
            showRoadLine(jsonStr);
        });

        bridge.clear_road_line.connect(function() {
            clearRoadLine();
        });

        bridge.show_analysis_circle.connect(function(jsonStr) {
            showAnalysisCircle(jsonStr);
        });

        bridge.clear_analysis_circle.connect(function() {
            clearAnalysisCircle();
        });

        bridge.set_wayback_version.connect(function(releaseNum) {
            setWaybackVersion(releaseNum);
        });

        bridge.on_map_ready();
    });
</script>
</body>
</html>
